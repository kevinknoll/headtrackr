<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Headtrackr</title>
  <style>
    canvas, video { border:1px solid #333; }
  </style>
</head>
<body>
  <canvas id="inputCanvas" width="320" height="240"></canvas>
  <canvas id="debugCanvas" width="320" height="240"></canvas>
  <video id="video" width="320" height="240"></video>
  <div id="flash"></div>
  <!--<script src="getUserMedia.js/dist/getUserMedia.js"></script>
  <script src="getUserMedia.js/gum.js"></script>-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="headtrackr2.js"></script>
  <script>
    var successCallback = function(){
      console.log('flash loaded successfully');
    };
    var errorCallback = function(){
      console.log('flash failed to load');
    };
    var fallback = function(options){
      window.webcam = options;
      // Fallback to flash
      var source, el, cam;

      source = '<object id="XwebcamXobjectX" type="application/x-shockwave-flash" data="' + options.swffile + '" width="' + options.width + '" height="' + options.height + '"><param name="movie"   value="' + options.swffile + '" /><param name="FlashVars" value="mode=' + options.mode + '&amp;quality=' + options.quality + '" /><param name="allowScriptAccess" value="always" /></object>  ';
      el = document.getElementById(options.el);
      el.innerHTML = source;

      (function register(run) {
          cam = document.getElementById('XwebcamXobjectX');
          if (cam.capture !== undefined) {
              // Simple callback methods are not allowed 
              options.capture = function (x) {
                  try {
                      return cam.capture(x);
                  } catch (e) {}
              };
              options.save = function (x) {
                  try {
                      return cam.save(x);
                  } catch (e) {}
              };
              options.setCamera = function (x) {
                  try {
                      return cam.setCamera(x);
                  } catch (e) {}
              };
              options.getCameraList = function () {
                  try {
                      return cam.getCameraList();
                  } catch (e) {}
              };
              // options.onLoad();
              options.context = 'flash';
              options.onLoad = successCallback;
          } else if (run === 0) {
              // options.debug("error", "Flash movie not yet registered!");
              errorCallback();
          } else {
              // Flash interface not ready yet 
              window.setTimeout(register, 1000 * (4 - run), run - 1);
          }
      }(3));
    };

    $(document).on('headtrackrStatus', function(e) {
      var oe = e.originalEvent,
          status = oe.status;

      console.log(e);
      if (status === 'no camera') {
        /*TODO: handle no camera*/
      } else if (status === 'no getUserMedia') {
        /*no userMedia, falling back to flash*/
        var app = {
          image:new Image(),
          pos:0,
          ctx:document.getElementById('inputCanvas').getContext('2d'),
          interval:null
        };
        app.image = app.ctx.getImageData(0, 0, 320, 240);
        /*load the swf*/
        fallback({
          swffile:'getUserMedia.js/dist/fallback/jscam_canvas_only.swf',
          mode:'callback',
          quality:85,
          width:320,
          height:240,
          el:'flash',
          debug:function(catg, msg){
            if (catg === 'notify' && msg === 'Camera started') {
              $('#flash').after('<button id="save">Save</button>');
              $('#save').on('click', function(){
                window.webcam.capture();
              });
              /*re-init the head tracker*/
              htracker.init(null, document.getElementById('inputCanvas'));
              htracker.start();
            }
          },
          onCapture:function(){
            window.webcam.save();
          },
          onSave:function(data){
            var col = data.split(';'),
                img = app.image,
                tmp = null,
                w = 320,
                h = 240;

            for (var i = 0; i < w; i++) {
              tmp = parseInt(col[i], 10);
              img.data[app.pos + 0] = (tmp >> 16) & 0xff;
              img.data[app.pos + 1] = (tmp >> 8) & 0xff;
              img.data[app.pos + 2] = tmp & 0xff;
              img.data[app.pos + 3] = 0xff;
              app.pos += 4;
            }

            if (app.pos >= 4 * w * h) {
              app.ctx.putImageData(img, 0, 0);
              app.pos = 0;
            }
          }
        });
      }
    });

    var htracker = new headtrackr.Tracker({
      debug:document.getElementById('debugCanvas')
    });
    htracker.init(document.getElementById('video'), document.getElementById('inputCanvas'));
    htracker.start();

    /*var canvas = document.getElementById('inputCanvas'),
        ctx = canvas.getContext('2d'),
        img = new Image(),
        interval;

    img.onload = function() {
      var x, y;
      interval = setInterval(function(){
        ctx.clearRect(0, 0, 320, 240);
        ctx.drawImage(img, Math.random() * 20, Math.random() * 20);
      },300);
    };
    img.src = 'nicenice.320.240.jpg';*/
  </script>
</body>
</html>